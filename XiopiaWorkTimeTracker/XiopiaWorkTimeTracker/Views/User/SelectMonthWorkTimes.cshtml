@using XiopiaWorkTimeTracker.Models
@using Ressources
@model UserViewModel

<link rel="stylesheet" href="~/Content/bootstrap.min.css">
<link type="text/css" rel="stylesheet" href="~/Scripts/jui_dropdown/jquery.jui_dropdown.css" />
<script type="text/javascript" src="~/Scripts/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="~/Scripts/bootstrap.min.js"></script>
<script type="text/javascript" src="~/Scripts/jui_dropdown/jquery.jui_dropdown.min.js"></script>

<div class="jumbotron">
    <h1 class="panel-title">@Language.UserHeader @Model.CurrentMonth @Model.CurrentYear</h1>
    <p class="data-current-user-title">@Model.User.FirstName @Model.User.LastName</p>
    <nav class="navbar navbar-default">
        <button id="startNowBtn" type="button" class="btn btn-primary btn-lg">@Language.StartWorkNow</button>
        <button id="endNowBtn" type="button" class="btn btn-success btn-lg">@Language.EndWork</button>
    </nav>
</div>
<nav>
    <ul class="pagination">
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 1})">@Language.January</a></li>
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 2})">@Language.February</a></li>
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 3})">@Language.March</a></li>
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 4})">@Language.April</a></li>
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 5})">@Language.Mai</a></li>
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 6})">@Language.Juni</a></li>
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 7})">@Language.July</a></li>
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 8})">@Language.August</a></li>
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 9})">@Language.September</a></li>
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 10})">@Language.October</a></li>
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 11})">@Language.November</a></li>
        <li><a href="@Url.Action("SelectMonthWorkTimes", "User", new { month = 12})">@Language.Dezember</a></li>
    </ul>
</nav>

<!--Modal Dialog-->
<!-- Modal HTML -->
<div id="myModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">@Language.NewWorkTime @DateTime.Now.ToString()</h4>
            </div>
            <div class="modal-body" id="client-detail-modal">
                @{Html.RenderPartial("StartRecordingNowDialog", Model);}
            </div>
        </div>
    </div>
</div>

<div id="tblWebGrid" class="container-fluid">
    <div class="row">
        <div class="col-lg-9">
            <div class="row webGrid-header">
                <div class="col-lg-2 center-block">@Language.Date</div>
                <div class="col-lg-2 center-block">@Language.StartWork</div>
                <div class="col-lg-1 center-block">@Language.PauseInMin</div>
                <div class="col-lg-2 center-block">@Language.EndWork</div>
                <div class="col-lg-3 center-block">@Language.Project</div>
                <div class="col-lg-1 center-block">@Language.ReportIllness</div>
                <div class="col-lg-1 center-block">@Language.RequestHoloday</div>
            </div>
            @foreach (var curDay in Model.WorkDays)
            {
                <div class="row">
                    <div class="col-lg-1 webGrid-Date date-dayofweek-@curDay.WorkDate.DayOfWeek.ToString("d")">@curDay.WorkDate.ToString("dd.MM")</div>
                    <div class="col-lg-1 webGrid-WeekDay date-dayofweek-@curDay.WorkDate.DayOfWeek.ToString("d")">@curDay.WorkDate.ToString("ddd")</div>
                    <div class="col-lg-10 container  form-group date-dayofweek-@curDay.WorkDate.DayOfWeek.ToString("d")">
                        @if (curDay.DataRow.Count == 0)
                        {
                            <div class="row bg-info webGrid-row date-dayofweek-@curDay.WorkDate.DayOfWeek.ToString("d")">
                                <div class="col-lg-2">
                                    <div class="webGrid-StartTime" style="text-align:center;vertical-align: middle;">00:00</div>
                                </div>
                                <div class="col-lg-2">
                                    <div class="webGrid-PauseLength" style="text-align:center;">00</div>
                                </div>
                                <div class="col-lg-2">
                                    <div class="webGrid-EndTime" style="text-align:center;">00:00</div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="webGrid-Proj">&nbsp;</div>
                                </div>
                                <div class="col-lg-1">
                                    <input type="checkbox" class="form-control Attr-Ill" />
                                </div>
                                <div class="col-lg-1">
                                    <input type="checkbox" class="form-control Attr-Holiday" />
                                </div>
                            </div>
                        }
                        else
                        {
                            foreach (var curEntry in curDay.DataRow)
                            {
                                <div class="row bg-info webGrid-row date-dayofweek-@curDay.WorkDate.DayOfWeek.ToString("d")">
                                    @Html.Hidden(curEntry.EntryId.ToString())
                                    @if (curEntry.AttrIll)
                                    {
                                        <div class="col-lg-10 field-illness">
                                            <h3>Krank !!!</h3>
                                        </div>
                                        <div class="col-lg-1">
                                            <input type="checkbox" class=" form-control  Attr-Ill" checked="@curEntry.AttrIll" />
                                        </div>
                                        <div class="col-lg-1"> </div>

                                    }
                                    else if (curEntry.AttrHoliday)
                                    {
                                        <div class="col-lg-10 field-holiday">
                                            <h3>Urlaub</h3>
                                        </div>
                                        <div class="col-lg-1">

                                        </div>
                                        <div class="col-lg-1">
                                            <input type="checkbox" class=" form-control Attr-Holiday" checked="@curEntry.AttrHoliday" />
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="col-lg-2">
                                            <div class="webGrid-StartTime">@curEntry.StartTime.Trim()</div>
                                        </div>
                                        <div class="col-lg-2">
                                            <div class="webGrid-PauseLength">@curEntry.PauseLength</div>
                                        </div>
                                        <div class="col-lg-2">
                                            <div class="webGrid-EndTime">@curEntry.EndTime</div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="webGrid-Proj">@curEntry.Project</div>
                                        </div>
                                        <div class="col-lg-1">
                                            <input type="checkbox" class=" form-control  Attr-Ill" />
                                        </div>
                                        <div class="col-lg-1">
                                            <input type="checkbox" class=" form-control  Attr-Holiday" />
                                        </div>
                                    }
                                </div>
                            }
                        }
                    </div>

                </div>
            }
        </div>
        <div class="col-lg-3">
            <div class="panel panel-default">
                <div class="panel-heading">Zusammenfassung</div>
                <div>Panel content</div>
            </div>
        </div>
    </div>
</div>

<script>
    debugger;

    $(document).ready(function(){
        $(".dropdown-toggle").dropdown();
    });

    $("#startNowBtn").on("click", function (event) {
        $("#myModal").modal('show');
    });

    $("#endNowBtn").on("click", function () {
        event.preventDefault();
        var newProjData = { "UserId": @Model.User.Id, "Action": "EndWork" };
        $.ajax({
            type: "POST",
            url: "/User/ActionFromView",
            data: newProjData,
            datatype: "html",
            success: function (data) {
                switch(data)
                {
                    case 0:
                        window.location.replace("/User/SelectMonthWorkTimes/?month=@Model.WorkDay.Month.ToString()");
                        break;
                    case 1:
                        alert("You have multiple Projects started today !");
                        break;
                    case 2:
                        alert("You don't have started any Projects today !");
                        break;
                    default:
                        break;
                }
            },
            error: function () {
                alert("error");
            }
        });

    })

    $(".webGrid-row").one('click', function(event){
        var node = event.target;
        var att = document.createAttribute("id");
        att.value = "editContaner";
        this.parentElement.setAttributeNode(att);

        var day = $("#editContaner").parent().find("div.webGrid-Date").text();

        var tmp = $("#editContaner").find("input[type=hidden]");
        var rowId = "";
        if((tmp != null) && (tmp.length > 0))
        {
            rowId = tmp[0].name;
        }
        if(node.className.indexOf("Attr-Ill") > -1)
        {
            var valJsn = '{ "Day" : "' + day +
            '", "Year" :"' + @Model.CurrentYear +
            '", "Month" :"' + @Model.WorkDay.Month +
            '", "AttrIll" :"' + node.checked + '"}';
            PostElementChange("Attr-Ill", rowId, valJsn);
            return;
        }
        else if(node.className.indexOf("Attr-Holiday") > -1)
        {
            var valJsn = '{ "Day" : "' + day +
            '", "Year" :"' + @Model.CurrentYear +
            '", "Month" :"' + @Model.WorkDay.Month +
            '", "AttrHoliday" :"' + node.checked + '"}';
            PostElementChange("Attr-Holiday", rowId, valJsn);
            return;
        }

        var editHtml = '<div class="row">\
                                    <input id="hiddenId" type="hidden" value="' + rowId + '"/>\
                                    <input id="hiddenDay" type="hidden" value="' + day + '"/>\
                                    <div class="col-lg-3">\
                                        <input type="time" id="editStartTime" class="form-control" autofocus value="' +
                                            $("#editContaner").find("div.webGrid-StartTime").text() + '"/>\
                                    </div>\
                                    <div class="col-lg-2">\
                                        <input type="number" id="editPause" class="form-control" value="' +
                                            $("#editContaner").find("div.webGrid-PauseLength").text()+ '"/>\
                                    </div>\
                                    <div class="col-lg-3">\
                                        <input type="time" id="editEndTime" class="form-control" value="' +
                                            $("#editContaner").find("div.webGrid-EndTime").text() + '"/>\
                                    </div>\
                                    <div class="col-lg-2">\
                                             <select id="editProject" name="Project"></select>\
                                    </div>\
                                    <div class="col-lg-1">&nbsp;</div>\
                                    <div class="col-lg-1">&nbsp;</div>\
                                </div>\
                                <div class="row"  style="margin:10px;">\
                                    <div class="col-lg-1">\
                                        <button type="button" onclick="SaveEdit()" class="btn btn-primary btn-xs">Save</button>\
                                    </div>\
                                    <div class="col-lg-1">\
                                        <button type="button" onclick="CancelEdit()" class="btn btn-default btn-xs">Cancel</button>\
                                    </div>\
                                    <div class="col-lg-10">\
                                        <button type="button" class="btn btn-primary btn-xs" style="margin-left:10px;">Add new project</button>\
                                    </div>\
                                </div>';
        $("#editContaner").html(editHtml);

        @foreach(var opt in Model.UserProjects)
        {
            @:var option = document.createElement("option");
            @:option.text = "@opt.Text";
            @:option.value = "@opt.Value";
            @:$("#editProject").append(option);
        }
    });

    function CancelEdit()
    {
        window.location.replace("/User/SelectMonthWorkTimes/?month=@Model.WorkDay.Month.ToString()");
    }

    function SaveEdit(date)
    {
        PostElementChange("Row", $("#hiddenId").val(),
            '{ "Day" : "' + $("#hiddenDay").val() +
            '", "Year" :"' + @Model.CurrentYear +
            '", "Month" :"' + @Model.WorkDay.Month +
            '", "StartTime" :"' + $("#editStartTime").val() +
            '", "EndTime" :"' + $("#editEndTime").val() +
            '", "PauseLength" :"' + $("#editPause").val() +
            '", "ProjectId" : " ' + $("#editProject").val() + '"}');
    }

    function PostElementChange(element, elementId, value)
    {
        $("#editElement").removeAttr("id");
        var newProjData = { "UserId": @Model.User.Id, "Action": "ElementChange", "ElementId": elementId, "Element":element, "Value": value};
        $.ajax({
            type: "POST",
            url: "/User/ActionFromView",
            data: newProjData,
            datatype: "html",
            success: function (data) {
                $("#editElement").removeAttr("id");
                switch(data)
                {
                    case 0:
                        window.location.replace("/User/SelectMonthWorkTimes/?month=@Model.WorkDay.Month.ToString()");
                        break;
                    default:
                        break;
                }
            },
            error: function () {
                alert("error");
            }
        });
    }

</script>
